---
title: ç½‘ç»œè¯·æ±‚
date: 2020-12-12
categories:
 - å‰ç«¯
tags:
- js
---

## Fetch åŸºæœ¬ä½¿ç”¨
`fetch`Â è¿”å›ä¸€ä¸ª `promise`Â ï¼Œå¸¸ç”¨æ–¹å¼ï¼š
```javascript
let response = await fetch(url, options); // è§£æ response header
let result = await response.json(); // å°† body è¯»å–ä¸º json
```

- `options`Â ï¼š
   - `method`Â ï¼šHTTP æ–¹æ³•ï¼Œå¦‚ getã€postâ€¦â€¦
   
   - `headers`Â ï¼šè¯·æ±‚å¤´ï¼Œä½†æ˜¯æœ‰ä¸€äº› header æ˜¯ä¸è¢«å…è®¸çš„ï¼Œè¯¦è§[è§„èŒƒ](https://fetch.spec.whatwg.org/#forbidden-header-name)Â 
   
   - `body`Â ï¼šrequest bodyï¼Œè¦ä»¥Â `string`Â ï¼Œ `FormData`Â ï¼Œ `BufferSource`Â ï¼Œ `Blob`Â Â æˆ–Â `UrlSearchParams`Â Â å¯¹è±¡çš„å½¢å¼å‘é€çš„æ•°æ®
   
     

æ¥æ”¶åˆ°çš„ `response`Â å±æ€§å¦‚ä¸‹ï¼š

- `response.status` â€”â€” response çš„ HTTP çŠ¶æ€ç ï¼Œ
- `response.ok` â€”â€” HTTP çŠ¶æ€ç ä¸º 200-299ï¼Œåˆ™ä¸º `true`ã€‚
- `response.headers` â€”â€” ç±»ä¼¼äº Map çš„å¸¦æœ‰ HTTP header çš„å¯¹è±¡ã€‚
> **æ³¨æ„**Â ï¼Œåªæœ‰åœ¨æ— æ³•å»ºç«‹ä¸€ä¸ª HTTP è¯·æ±‚çš„æ—¶å€™ï¼Œ `fetch`Â æ‰ä¼š `reject`Â ã€‚è€Œå¼‚å¸¸çš„ `404ã€500`Â ç­‰çŠ¶æ€ä¸ä¼šå¯¼è‡´å¼‚å¸¸



è·å– `response body`Â :

- `response.text()` â€”â€” è¯»å– responseï¼Œå¹¶ä»¥æ–‡æœ¬å½¢å¼è¿”å› responseï¼Œ
- `response.json()` â€”â€” å°† response è§£æä¸º JSON å¯¹è±¡å½¢å¼ï¼Œ
- `response.formData()` â€”â€” ä»¥ `FormData` å¯¹è±¡ï¼ˆform/multipart ç¼–ç ï¼Œå‚è§ä¸‹ä¸€ç« ï¼‰çš„å½¢å¼è¿”å› responseï¼Œ
- `response.blob()` â€”â€” ä»¥ [Blob](https://zh.javascript.info/blob)ï¼ˆå…·æœ‰ç±»å‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼‰å½¢å¼è¿”å› responseï¼Œ
- `response.arrayBuffer()` â€”â€” ä»¥ [ArrayBuffer](https://zh.javascript.info/arraybuffer-binary-arrays)ï¼ˆä½çº§åˆ«çš„äºŒè¿›åˆ¶æ•°æ®ï¼‰å½¢å¼è¿”å› responseã€‚



## FormData
### å‘é€è¡¨å•
`FormData`Â å¯¹è±¡å¯ä»¥å‘é€è¡¨å•å¯¹è±¡å†…å®¹ï¼Œæ¯”å¦‚ï¼š
```html
<form id="formElem">
  <input type="text" name="name" value="John">
  <input type="text" name="surname" value="Smith">
  <input type="submit">
</form>

<script>
  formElem.onsubmit = async (e) => {
    e.preventDefault();

    let response = await fetch('/article/formdata/post/user', {
      method: 'POST',
      body: new FormData(formElem)
    });

    let result = await response.json();

    alert(result.message);
  };
</script>
```
è¿™æ ·å¯ä»¥æŠŠæ•´ä¸ªè¡¨å•å¯¹è±¡å‘é€å‡ºå»ã€‚


æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•å»ä¿®æ”¹æ·»åŠ è¡¨å•å¯¹è±¡åˆ° `FormData`Â Â ï¼š

- `formData.append(name, value)`Â  â€”â€” æ·»åŠ å…·æœ‰ç»™å®š name å’Œ value çš„è¡¨å•å­—æ®µï¼Œ
- `formData.append(name, blob, fileName)`Â  â€”â€” æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œå°±åƒå®ƒæ˜¯ `<input type='file'>`Â Â ï¼Œç¬¬ä¸‰ä¸ªå‚æ•° fileName è®¾ç½®æ–‡ä»¶åï¼ˆè€Œä¸æ˜¯è¡¨å•å­—æ®µåï¼‰ï¼Œå› ä¸ºå®ƒæ˜¯ç”¨æˆ·æ–‡ä»¶ç³»ç»Ÿä¸­æ–‡ä»¶çš„åç§°
- `formData.set(name,value)` â€”â€” set æ–¹æ³•ä¼šæ¸…æ¥šå½“å‰ `formData` ä¸­æ‰€æœ‰æ­¤ `name` çš„å­—æ®µï¼Œç„¶åæ’å…¥æ–°çš„ `value`
- `formData.set(name,blob,value)` â€”â€” åŸç†åŒä¸Š
- `formData.delete(name)`Â  â€”â€” ç§»é™¤å¸¦æœ‰ç»™å®š name çš„å­—æ®µï¼Œ
- `formData.get(name)`Â  â€”â€” è·å–å¸¦æœ‰ç»™å®š name çš„å­—æ®µå€¼ï¼Œ
- `formData.has(name)`Â  â€”â€” å¦‚æœå­˜åœ¨å¸¦æœ‰ç»™å®š name çš„å­—æ®µï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚



`FormData`Â å¯¹è±¡æ˜¯å¯ä»¥å¾ªç¯çš„ ï¼š `for(let[key,value] of formData){} `
### å‘é€æ–‡ä»¶
Â `<input type="file">`Â å…è®¸æˆ‘ä»¬å‘é€ä¸€ä¸ªæ–‡ä»¶ï¼š
```html
<input type="file" id="pic">
  
<script>
  let formData = new FormData()
  pic.onchange = function(e){
		formData.append("fileIn",this.value)
	}
  let response = await fetch('/xxx', {
    method: 'POST',
    body: formData
  });

  let result = await response.json();
  
  
</script>
```
## ä¸‹è½½è¿›åº¦
å¯ä»¥é€šè¿‡ `response.body`Â ï¼Œå®ƒæ˜¯Â `ReadableStream`Â â€”â€” ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œå®ƒå¯ä»¥é€å—ï¼ˆchunkï¼‰æä¾› bodyã€‚åœ¨Â [Streams API](https://streams.spec.whatwg.org/#rs-class)Â è§„èŒƒä¸­æœ‰å¯¹Â `ReadableStream`Â çš„è¯¦ç»†æè¿°ã€‚
ç„¶åå¯ä»¥é€šè¿‡ä»–çš„ `getReader()`Â æ¥è·å–ä¸€ä¸ªæµè¯»å–å™¨ï¼ˆstream readerï¼‰ï¼š
```javascript
// Step 1ï¼šå¯åŠ¨ fetchï¼Œå¹¶è·å¾—ä¸€ä¸ª reader
let response = await fetch('https://api.github.com/repos/javascript-tutorial/en.javascript.info/commits?per_page=100');

const reader = response.body.getReader();

// Step 2ï¼šè·å¾—æ€»é•¿åº¦ï¼ˆlengthï¼‰
const contentLength = +response.headers.get('Content-Length');

// Step 3ï¼šè¯»å–æ•°æ®
let receivedLength = 0; // å½“å‰æ¥æ”¶åˆ°äº†è¿™ä¹ˆå¤šå­—èŠ‚
let chunks = []; // æ¥æ”¶åˆ°çš„äºŒè¿›åˆ¶å—çš„æ•°ç»„ï¼ˆåŒ…æ‹¬ bodyï¼‰
while(true) {
  // read() ä¼šè¿”å›done â€”â€” è¯»å–å®Œæˆæ—¶æ˜¯ trueï¼Œå¦åˆ™ false
  //è¿˜æœ‰ value â€”â€” å­—èŠ‚çš„ç±»å‹åŒ–æ•°ç»„ï¼šUint8Arrayã€‚
  const {done, value} = await reader.read();

  if (done) {
    break;
  }
	// æ¯æ‹¿åˆ°ä¸€å— å°±æ”¾å…¥äºŒè¿›åˆ¶æ•°ç»„
  chunks.push(value);
  receivedLength += value.length;

  console.log(`Received ${receivedLength} of ${contentLength}`)
}
// æ¥æ”¶å·²å®Œæˆï¼Œä»¥ä¸‹æ˜¯å¤„ç†è¿‡ç¨‹ã€‚
// Step 4ï¼šå°†å—è¿æ¥åˆ°å•ä¸ª Uint8Array
let chunksAll = new Uint8Array(receivedLength); // (4.1)
let position = 0;
for(let chunk of chunks) {
  chunksAll.set(chunk, position); // (4.2)
  position += chunk.length;
}

// Step 5ï¼šè§£ç æˆå­—ç¬¦ä¸²
let result = new TextDecoder("utf-8").decode(chunksAll);

// æˆ‘ä»¬å®Œæˆå•¦ï¼
let commits = JSON.parse(result);
```
## Fetch ä¸­æ­¢
æˆ‘ä»¬æœ‰ä¸€ä¸ª `AbortController`Â å¯¹è±¡ï¼Œä»–çš„ç”¨æ³•å¾ˆç®€å•ï¼š
```javascript
let aContro = new AbortController()
// å±æ€§ signalï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªå±æ€§ä¸Šè®¾ç½®äº‹ä»¶ç›‘å¬å™¨ã€‚
let singal = aContro.signal
// æ–¹æ³• abort()
aContro.abort()
// äº‹ä»¶è§¦å‘åï¼Œsignal.aborted å˜ä¸º true
alert(signal.aborted); // true
```
ç»“åˆ fetchï¼š
```javascript
// 1 ç§’åä¸­æ­¢
let controller = new AbortController();
setTimeout(() => controller.abort(), 1000);

try {
  let response = await fetch('/article/fetch-abort/demo/hang', {
    signal: controller.signal
  });
} catch(err) {
  if (err.name == 'AbortError') { // handle abort()
    alert("Aborted!");
  } else {
    throw err;
  }
}
```
## Fetch Api
fetch è¿˜æœ‰å¾ˆå¤š apiï¼Œè¯¦è§ [ç°ä»£æ•™ç¨‹](https://zh.javascript.info/fetch-api)Â 
## CORS è·¨åŸŸ
Â **"CORS"**Â ï¼šè·¨æºèµ„æºå…±äº«ï¼ˆCross-Origin Resource Sharingï¼‰ã€‚
### JSONP
JSONP çš„åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ©ç”¨ä¸€ä¸ª `script`Â æ ‡ç­¾ï¼Œç„¶åæˆ‘ä»¬çš„ä¿¡æ¯ä½œä¸ºå›è°ƒå‡½æ•°ä¼ è¿‡å»æ¥å®ç°è·¨åŸŸï¼š
```javascript
function gotWeather({ temperature, humidity }) {
  alert(`temperature: ${temperature}, humidity: ${humidity}`);
}

let script = document.createElement('script');
script.src = `http://another.com/weather.json?callback=gotWeather`;
document.body.append(script);

```
### ç®€å•è·¨åŸŸè¯·æ±‚
é¦–å…ˆï¼Œç®€å•è·¨åŸŸè¯·æ±‚éœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š

- `method`Â â€”â€” GETï¼ŒPOST æˆ– HEAD
- `headers`Â â€”â€” ä»…å…è®¸è‡ªå®šä¹‰ä¸‹åˆ— headerï¼š
   - Acceptï¼Œ
   - Accept-Languageï¼Œ
   - Content-Languageï¼Œ
   - Content-Type çš„**å€¼**ä¸º application/x-www-form-urlencodedï¼Œmultipart/form-data æˆ– text/plainã€‚



å¦‚æœæˆ‘ä»¬çš„è·¨åŸŸè¯·æ±‚æ˜¯ä¸€ä¸ªç®€å•è¯·æ±‚ï¼Œåœ¨å‘é€ request çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ·»åŠ  `Origin`Â headerï¼ŒæœåŠ¡å™¨éœ€è¦è¿›è¡Œå¯¹ `Origin`Â çš„æ£€æŸ¥ï¼Œå¦‚æœåŒæ„è¿™ä¸ªæºçš„ request ï¼Œé‚£ä¹ˆåœ¨ response é‡Œå°±ä¼šæ·»åŠ ä¸€ä¸ª `Access-Control-Allow-Origin`Â çš„å“åº”å¤´ï¼Œè¿™ä¸ªå“åº”å¤´çš„å†…å®¹å¯ä»¥æ˜¯æˆ‘ä»¬åˆšæ‰çš„ `Origin`Â ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª `*`Â å· ï¼š
![image.png](https://gitee.com/rodrick278/img/raw/master/img/1607741264922-5556f12f-a1de-455c-a383-fcfdb5d15561.png)


è€Œä¸”åœ¨è¿™ç§ç®€å•è¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬åªèƒ½è®¿é—®ç®€å•çš„ `response header`Â ï¼š

- Cache-Control
- Content-Language
- Content-Type
- Expires
- Last-Modified
- Pragma

å…¶ä»–çš„éƒ½ä¸å¯è®¿é—®


### éç®€å•è·¨åŸŸè¯·æ±‚
ä¸æ»¡è¶³æˆ‘ä»¬ä¸Šé¢è¯´çš„ request æ¡ä»¶çš„è¯·æ±‚è§†ä¸ºéç®€å•è¯·æ±‚ï¼Œæ¯”å¦‚ `method` æ˜¯ `PUT`Â ï¼Œå‘é€è¿™æ ·çš„è¯·æ±‚çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šåœ¨å‘é€æ­£å¼è¯·æ±‚å‰ **åŠ ä¸€ä¸ªé¢„æ£€ï¼ˆpreflightï¼‰ **çš„è¯·æ±‚


é¢„æ£€è¯·æ±‚ä½¿ç”¨ `OPTIONS`Â methodï¼Œå®ƒæ²¡æœ‰ `body`Â ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªå…³é”® `header` ï¼š

- `Access-Control-Request-Method`Â â€”â€” æ­£å¼è¯·æ±‚ä¸­å¸¦æœ‰çš„éç®€å•è¯·æ±‚çš„ `method`Â 
- `Access-Control-Request-Headers`Â â€”â€” æ­£å¼è¯·æ±‚ä¸­å¸¦æœ‰çš„éç®€å•çš„ `HTTP-Header`Â åˆ—è¡¨ï¼Œç”¨ `,`Â åˆ†éš”



è€ŒæœåŠ¡å™¨ç«¯åŒæ„å¤„ç†ä¹Ÿä¼šè¿”å›ä¸€ä¸ª**çŠ¶æ€ç **ä¸º `200`Â ï¼Œæ²¡æœ‰ `body`Â ä½†æ˜¯æœ‰ä¸€äº›ç‰¹æ®Š `header`Â çš„  responseï¼š

- `Access-Control-Allow-Origin` å¿…é¡»ä¸º `*` æˆ–è¿›è¡Œè¯·æ±‚çš„æºï¼ˆä¾‹å¦‚ `[https://javascript.info](https://javascript.info)`ï¼‰æ‰èƒ½å…è®¸æ­¤è¯·æ±‚ã€‚
- `Access-Control-Allow-Methods` å¿…é¡»å…·æœ‰å…è®¸çš„æ–¹æ³•ã€‚
- `Access-Control-Allow-Headers` å¿…é¡»å…·æœ‰ä¸€ä¸ªå…è®¸çš„ header åˆ—è¡¨ã€‚
- å¦å¤–ï¼Œheader `Access-Control-Max-Age` å¯ä»¥æŒ‡å®šç¼“å­˜æ­¤æƒé™çš„ç§’æ•°ã€‚å› æ­¤ï¼Œæµè§ˆå™¨ä¸æ˜¯å¿…é¡»ä¸ºæ»¡è¶³ç»™å®šæƒé™çš„åç»­è¯·æ±‚å‘é€é¢„æ£€ã€‚

![image.png](https://gitee.com/rodrick278/img/raw/master/img/1607741884520-ebbb5674-e454-4f7a-9d65-032684052a4f.png)Â 
**é¢„æ£€è¯·æ±‚æ•´ä¸ªè¿‡ç¨‹å¯¹äº JavaScript æ˜¯ä¸å¯è§çš„ï¼JavaScript ä»…ä»…è·å–ä¸»è¯·æ±‚çš„ response**Â 


### éç®€å•è·¨åŸŸä¾‹å­
å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªè·¨åŸŸè¯·æ±‚
```javascript
let response = await fetch('https://site.com/service.json', {
  method: 'PATCH',
  headers: {
    'Content-Type': 'application/json',
    'API-Key': 'secret'
  }
});
```
ä»–çš„ `method`Â ã€ `headers`Â éƒ½ä¸æ»¡è¶³ç®€å•è¯·æ±‚çš„è§„åˆ™ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¼šå‘ç”Ÿéç®€å•è¯·æ±‚ï¼š
#### ç¬¬ä¸€æ­¥ å‘é€é¢„æ£€è¯·æ±‚
æµè§ˆå™¨æ£€æµ‹åˆ°éç®€å•è·¨åŸŸè¯·æ±‚åï¼Œä¼šè‡ªåŠ¨å…ˆå‘é€ä¸€ä¸ªé¢„æ£€
```
OPTIONS /service.json
Host: site.com
Origin: https://javascript.info
Access-Control-Request-Method: PATCH
Access-Control-Request-Headers: Content-Type,API-Key
```
åŒ…å«äº†ä¸Šé¢è¯´çš„éç®€å•è¯·æ±‚çš„ `method` å’Œ éç®€å•çš„ `HTTP-Header` åˆ—è¡¨
#### ç¬¬äºŒæ­¥ æœåŠ¡å™¨å“åº”é¢„æ£€è¯·æ±‚
```
200 OK
Access-Control-Allow-Origin: https://javascript.info
Access-Control-Allow-Methods: PUT,PATCH,DELETE
Access-Control-Allow-Headers: API-Key,Content-Type,If-Modified-Since,Cache-Control
Access-Control-Max-Age: 86400
```
è¿™ä¸ª response è¡¨ç¤ºï¼š 

1. è¯·æ±‚é€šè¿‡ `200`Â ï¼Œ
1. å…è®¸çš„ `Origin`Â æ˜¯æˆ‘ä»¬ request çš„æºï¼Œ
1. ä»–ä¸ä»…å…è®¸æˆ‘ä»¬ request çš„ `PATCH`Â ï¼Œè¿˜å…è®¸ `PUT/DELETE`Â ç­‰ç‰¹æ®Š `method`Â ï¼Œå½“ç„¶ `GETï¼ŒPOST æˆ– HEAD`Â æœ¬èº«å°±æ˜¯å…è®¸çš„ï¼Œresponse ä¸ç”¨å†™è¿›å»  
1. ä¹Ÿå…è®¸äº†ä¸€äº› `header`Â :Â `API-Key,Content-Type,If-Modified-Since,Cache-Control`Â 
1. è®¾ç½®äº†ç¼“å­˜æ—¶é—´ä¸€å¤©ï¼Œåç»­çš„è¯·æ±‚å°±ä¸ç”¨å†è§¦å‘é¢„æ£€äº†
#### ç¬¬ä¸‰æ­¥ å‘é€å®é™…è¯·æ±‚
é€šè¿‡äº†é¢„æ£€ï¼Œè‡ªç„¶æ˜¯å¼€å§‹å‘é€å®é™… requsetï¼Œæ³¨æ„æµè§ˆå™¨ä¸€å®šä¼šåŠ ä¸Š `Origin header` ï¼Œå› ä¸ºä»–æ˜¯è·¨åŸŸçš„Â 
```
PATCH /service.json
Host: site.com
Content-Type: application/json
API-Key: secret
Origin: https://javascript.info
```
#### ç¬¬å››æ­¥ è¿”å›å®é™…å“åº”
æœåŠ¡å™¨è¿”å›çš„ response ä¹Ÿå¿…é¡»åŠ ä¸Š `Access-Control-Allow-Origin`ï¼Œå³æ—¶æˆ‘ä»¬å·²ç»é€šè¿‡äº†é¢„æ£€
```
Access-Control-Allow-Origin: https://javascript.info
```
Â è‡³æ­¤ä¸€ä¸ªéç®€å•è·¨åŸŸå®Œæˆ
### å‡­æ®
åœ¨ä¸Šé¢çš„è·¨åŸŸæƒ…å†µä¸­ï¼Œæ— æ³•å‘é€ä»»ä½• **å‡­æ®ï¼ˆcookies æˆ–è€… HTTP è®¤è¯ï¼‰**Â 
è¿™æ˜¯å› ä¸ºå…·æœ‰å‡­æ®çš„è¯·æ±‚æ¯”æ²¡æœ‰å‡­æ®çš„è¯·æ±‚è¦å¼ºå¤§å¾—å¤šã€‚å¦‚æœè¢«å…è®¸ï¼Œå®ƒä¼šä½¿ç”¨å®ƒä»¬çš„å‡­æ®æˆäºˆ JavaScript ä»£è¡¨ç”¨æˆ·è¡Œä¸ºå’Œè®¿é—®æ•æ„Ÿä¿¡æ¯çš„**å…¨éƒ¨æƒåŠ›**ã€‚
å¦‚æœéœ€è¦å‘é€å‡­æ®ï¼Œéœ€è¦åŠ ä¸Š `credentials: "include"`Â ï¼š

```javascript
fetch('http://another.com', {
  credentials: "include"
});
```
è€ŒæœåŠ¡å™¨å¦‚æœåŒæ„æ¥å—å¸¦æœ‰å‡­æ®çš„è¯·æ±‚ï¼Œé‚£ä¹ˆéœ€è¦åŠ ä¸Šä¸€ä¸ª headerï¼š `Access-Control-Allow-Credentials: true`Â ï¼Œå½“ç„¶ä¹Ÿåˆ«å¿˜è®°å¿…é¡»æœ‰çš„ `Access-Control-Allow-Origin`Â 
```javascript
200 OK
Access-Control-Allow-Origin: https://javascript.info
Access-Control-Allow-Credentials: true
```
## URL å¯¹è±¡
ä»¥å¾€æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªçª—å£ï¼Œå¯èƒ½ä¼šç”¨å¦‚ä¸‹æ–¹å¼ï¼š
```javascript
window.open("https://zh.javascript.info/url")
```
è¿™ç§æ–¹å¼ï¼Œurl æ˜¯ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œè€Œç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªå†…å»ºçš„ `URL`Â å¯¹è±¡
```javascript
new URL(url, [base])
```
å¦‚ä¸‹ä¸¤ä¸ª url æ˜¯ä¸€æ ·çš„
```javascript
let url1 = new URL('https://javascript.info/profile/admin');
let url2 = new URL('/profile/admin', 'https://javascript.info');

alert(url1); // https://javascript.info/profile/admin
alert(url2); // https://javascript.info/profile/admin
```
ä¹Ÿå¯ä»¥æ ¹æ®ç°æœ‰ URL  åˆ›å»ºæ–° URL 
```javascript
let url = new URL('https://javascript.info/profile/admin');
let newUrl = new URL('tester', url);

alert(newUrl); // https://javascript.info/profile/tester
```
è¿˜å¯ä»¥è®¿é—®ä»–çš„ç»„ä»¶å±æ€§
```javascript
let url = new URL('https://javascript.info/url');

alert(url.protocol); // https:
alert(url.host);     // javascript.info
alert(url.pathname); // /url
```
![image.png](https://gitee.com/rodrick278/img/raw/master/img/1607745568328-b8b315bb-8d10-4b68-8f06-24cf1a91101f.png)
æˆ‘ä»¬è¿˜å¯ä»¥å¤„ç† url çš„å‚æ•°ï¼š

- `append(name, value)`Â  â€”â€” æŒ‰ç…§ name æ·»åŠ å‚æ•°ï¼Œ
- `delete(name)`Â  â€”â€” æŒ‰ç…§ name ç§»é™¤å‚æ•°ï¼Œ
- `get(name)`Â  â€”â€” æŒ‰ç…§ name è·å–å‚æ•°ï¼Œ
- `getAll(name)`Â â€”â€” è·å–ç›¸åŒ name çš„æ‰€æœ‰å‚æ•°ï¼ˆè¿™æ˜¯å¯è¡Œçš„ï¼Œä¾‹å¦‚ ?user=John&user=Peteï¼‰ï¼Œ
- `has(name)`Â  â€”â€” æŒ‰ç…§ name æ£€æŸ¥å‚æ•°æ˜¯å¦å­˜åœ¨ï¼Œ
- `set(name, value)`Â  â€”â€” set/replace å‚æ•°ï¼Œ
- `sort()`Â  â€”â€” æŒ‰ name å¯¹å‚æ•°è¿›è¡Œæ’åºï¼Œå¾ˆå°‘ä½¿ç”¨ï¼Œ

è¿™äº›æ–¹æ³•å¤„ç†å‚æ•°çš„æ—¶å€™ï¼Œä¼š**è‡ªåŠ¨è¿›è¡Œç¼–ç **
ä¼ ç»Ÿçš„ç¼–ç ä¸€èˆ¬æ˜¯ç”¨è¿™äº›æ–¹æ³•ï¼š

- [encodeURI](https://developer.mozilla.org/zh/docs/Web/JavaScript/Reference/Global_Objects/encodeURI) â€”â€” ç¼–ç æ•´ä¸ª URLã€‚
- [decodeURI](https://developer.mozilla.org/zh/docs/Web/JavaScript/Reference/Global_Objects/decodeURI) â€”â€” è§£ç ä¸ºç¼–ç å‰çš„çŠ¶æ€ã€‚
- [encodeURIComponent](https://developer.mozilla.org/zh/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent) â€”â€” ç¼–ç  URL ç»„ä»¶ï¼Œä¾‹å¦‚æœç´¢å‚æ•°ï¼Œæˆ–è€… hashï¼Œæˆ–è€… pathnameã€‚
- [decodeURIComponent](https://developer.mozilla.org/zh/docs/Web/JavaScript/Reference/Global_Objects/decodeURIComponent) â€”â€” è§£ç ä¸ºç¼–ç å‰çš„çŠ¶æ€ã€‚
## è½®è¯¢
### çŸ­è½®è¯¢
çŸ­è½®è¯¢å°±æ˜¯å®šæ—¶åœ°å¯¹æœåŠ¡å™¨è¿›è¡Œ request
### é•¿è½®è¯¢
å‘é€ request -> æ¶ˆæ¯æŒ‚èµ· -> æœåŠ¡å™¨ response è¿”å› -> å®¢æˆ·ç«¯å¤„ç† response -> å‘èµ·ä¸‹ä¸€ä¸ª request
```javascript
async function subscribe() {
  let response = await fetch("/subscribe");

  if (response.status == 502) {
    // çŠ¶æ€ 502 æ˜¯è¿æ¥è¶…æ—¶é”™è¯¯ï¼Œ
    // è¿æ¥æŒ‚èµ·æ—¶é—´è¿‡é•¿æ—¶å¯èƒ½ä¼šå‘ç”Ÿï¼Œ
    // è¿œç¨‹æœåŠ¡å™¨æˆ–ä»£ç†ä¼šå…³é—­å®ƒ
    // è®©æˆ‘ä»¬é‡æ–°è¿æ¥
    await subscribe();
  } else if (response.status != 200) {
    // ä¸€ä¸ª error â€”â€” è®©æˆ‘ä»¬æ˜¾ç¤ºå®ƒ
    showMessage(response.statusText);
    // ä¸€ç§’åé‡æ–°è¿æ¥
    await new Promise(resolve => setTimeout(resolve, 1000));
    await subscribe();
  } else {
    // è·å–å¹¶æ˜¾ç¤ºæ¶ˆæ¯
    let message = await response.text();
    showMessage(message);
    // å†æ¬¡è°ƒç”¨ subscribe() ä»¥è·å–ä¸‹ä¸€æ¡æ¶ˆæ¯
    await subscribe();
  }
}

subscribe();
```
## WebSocket
### åˆ›å»ºè¿æ¥
`WebSocket`Â Â åè®®æä¾›äº†ä¸€ç§åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹æŒä¹…è¿æ¥æ¥äº¤æ¢æ•°æ®çš„æ–¹æ³•ã€‚æ•°æ®å¯ä»¥ä½œä¸ºâ€œæ•°æ®åŒ…â€åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¼ é€’ï¼Œè€Œä¸ä¼šæ–­å¼€è¿æ¥å’Œå…¶ä»– HTTP è¯·æ±‚ã€‚
```javascript
let socket = new WebSocket("ws://javascript.info");
```
`ws`Â æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åè®® ï¼Œè¿˜æœ‰ä¸€ä¸ª `wss`Â åè®®ï¼Œç±»ä¼¼äº HTTPS ä»–æ˜¯åŠ å¯†çš„ï¼Œå»ºè®®ä½¿ç”¨ `wss://`Â 

- `open`Â Â  â€”â€” è¿æ¥å·²å»ºç«‹ï¼Œ
- `message`Â Â  â€”â€” æ¥æ”¶åˆ°æ•°æ®ï¼Œ
- `error`Â Â  â€”â€” WebSocket é”™è¯¯ï¼Œ
- `close`Â Â  â€”â€” è¿æ¥å·²å…³é—­ã€‚
```javascript
let socket = new WebSocket("wss://javascript.info/article/websocket/demo/hello");

socket.onopen = function(e) {
  alert("[open] Connection established");
  alert("Sending to server");
  socket.send("My name is John");
};

socket.onmessage = function(event) {
  alert(`[message] Data received from server: ${event.data}`);
};

socket.onclose = function(event) {
  if (event.wasClean) {
    alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
  } else {
    // ä¾‹å¦‚æœåŠ¡å™¨è¿›ç¨‹è¢«æ€æ­»æˆ–ç½‘ç»œä¸­æ–­
    // åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œevent.code é€šå¸¸ä¸º 1006
    alert('[close] Connection died');
  }
};

socket.onerror = function(error) {
  alert(`[error] ${error.message}`);
};
```
### request
ä»¥ä¸‹æ˜¯ç”±Â `new WebSocket("wss://javascript.info/chat")`Â Â å‘å‡ºçš„è¯·æ±‚çš„æµè§ˆå™¨ header ç¤ºä¾‹ã€‚
```
GET /chat
Host: javascript.info
Origin: https://javascript.info    [å®¢æˆ·ç«¯é¡µé¢çš„æº]
Connection: Upgrade		[Upgrade â€”â€” è¡¨ç¤ºå®¢æˆ·ç«¯æƒ³è¦æ›´æ”¹åè®®ã€‚]
Upgrade: websocket		[websocket â€”â€” è¯·æ±‚çš„åè®®æ˜¯ â€œwebsocketâ€]
Sec-WebSocket-Key: Iv8io/9s+lYFgZWcXczP8Q==		[æµè§ˆå™¨éšæœºç”Ÿæˆçš„å®‰å…¨å¯†é’¥]
Sec-WebSocket-Version: 13		[WebSocket åè®®ç‰ˆæœ¬ï¼Œå½“å‰ä¸º 13]
```
è¿™äº› header åœ¨JavaScript ä¸­ä¸å¯è§ã€‚
è¿˜æœ‰ `Sec-WebSocket-Protocol: soap, wamp`Â ä»£è¡¨æˆ‘ä»¬ä¸ä»…è¦ä¼ è¾“ä»»ä½•æ•°æ®ï¼Œè¿˜è¦ä¼ è¾“Â [SOAP](http://en.wikipedia.org/wiki/SOAP)Â æˆ– WAMP åè®®ä¸­çš„æ•°æ®ã€‚è¿™ä¸ªæ˜¯æˆ‘ä»¬å¯è®¾ç½®çš„ï¼š
```javascript
let socket = new WebSocket("wss://javascript.info/chat", ["soap", "wamp"]);
```
### æ•°æ®ä¼ è¾“
WebSocket é€šä¿¡ç”± â€œframesâ€ï¼ˆå³æ•°æ®ç‰‡æ®µï¼‰ç»„æˆï¼Œå¯ä»¥ä»ä»»ä½•ä¸€æ–¹å‘é€ï¼Œå¹¶ä¸”æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

- â€œtext framesâ€ â€”â€” åŒ…å«å„æ–¹å‘é€ç»™å½¼æ­¤çš„æ–‡æœ¬æ•°æ®ã€‚
- â€œbinary data framesâ€ â€”â€” åŒ…å«å„æ–¹å‘é€ç»™å½¼æ­¤çš„äºŒè¿›åˆ¶æ•°æ®ã€‚
- â€œping/pong framesâ€ è¢«ç”¨äºæ£€æŸ¥ä»æœåŠ¡å™¨å‘é€çš„è¿æ¥ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å“åº”å®ƒä»¬ã€‚
- è¿˜æœ‰ â€œconnection close frameâ€ ä»¥åŠå…¶ä»–æœåŠ¡ framesã€‚



**å®¢æˆ·ç«¯è¯·æ±‚** `.send()`Â å¯ä»¥å‘é€æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®ï¼ˆåŒ…æ‹¬ Blobï¼ŒArrayBuffer ç­‰ï¼‰


è€Œ**æ¥æ”¶åˆ° response** çš„æ—¶å€™ï¼Œæ–‡æœ¬è‚¯å®šæ˜¯å­—ç¬¦ä¸²çš„å½¢å¼ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä¸ªäºŒè¿›åˆ¶æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ `socket.binaryType`Â æ¥è®¾ç½®æ ¼å¼ç±»å‹ï¼Œé»˜è®¤å€¼å°±æ˜¯ `blob`Â ã€‚
```javascript
socket.binaryType = "arraybuffer"; // é»˜è®¤å€¼æ˜¯ blob å¯ä»¥ä¸è®¾ç½®
socket.onmessage = (event) => {
  // event.data å¯ä»¥æ˜¯æ–‡æœ¬ï¼ˆå¦‚æœæ˜¯æ–‡æœ¬ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯ arraybufferï¼ˆå¦‚æœæ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼‰
};
```
### ç¼“å†²æ•°æ®
å‡è®¾æˆ‘ä»¬ä¸€æ¬¡å‘é€äº†å¾ˆå¤šæ•°æ®ï¼Œä½†æ˜¯ç½‘å¾ˆæ…¢ï¼Œå½“æˆ‘ä»¬åå¤ `send()`Â çš„æƒ…å†µä¸‹ï¼Œæ•°æ®ä¼šç¼“å­˜è¿›å†…å­˜ï¼Œ `socket.bufferedAmount`Â å¯ä»¥æŸ¥è¯¢å½“å‰ç¼“å­˜äº†å¤šå°‘å­—èŠ‚
```javascript
// æ¯ 100ms æ£€æŸ¥ä¸€æ¬¡ socket
// ä»…å½“æ‰€æœ‰ç°æœ‰çš„æ•°æ®éƒ½å·²è¢«å‘é€å‡ºå»æ—¶ï¼Œå†å‘é€æ›´å¤šæ•°æ®
setInterval(() => {
  if (socket.bufferedAmount == 0) {
    socket.send(moreData());
  }
}, 100);
```
### å…³é—­è¿æ¥
ä¸ç®¡æ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯éƒ½å¯ä»¥ä¸»åŠ¨å…³é—­è¿æ¥ï¼Œå½“éœ€è¦å…³é—­çš„æ—¶å€™ï¼š
```javascript
socket.close(code,reason)
```

- `code`Â â€”â€” ä¸€ä¸ªå…³é—­ç ï¼š
   - 1000 â€”â€” é»˜è®¤ï¼Œæ­£å¸¸å…³é—­ï¼ˆå¦‚æœæ²¡æœ‰æŒ‡æ˜ code æ—¶ä½¿ç”¨å®ƒï¼‰ï¼Œ
   - 1006 â€”â€” æ²¡æœ‰åŠæ³•æ‰‹åŠ¨è®¾å®šè¿™ä¸ªæ•°å­—ç ï¼Œè¡¨ç¤ºè¿æ¥ä¸¢å¤±ï¼ˆæ²¡æœ‰ close frameï¼‰ã€‚
   - 1001 â€”â€” ä¸€æ–¹æ­£åœ¨ç¦»å¼€ï¼Œä¾‹å¦‚æœåŠ¡å™¨æ­£åœ¨å…³é—­ï¼Œæˆ–è€…æµè§ˆå™¨ç¦»å¼€äº†è¯¥é¡µé¢ï¼Œ
   - 1009 â€”â€” æ¶ˆæ¯å¤ªå¤§ï¼Œæ— æ³•å¤„ç†ï¼Œ
   - 1011 â€”â€” æœåŠ¡å™¨ä¸Šå‘ç”Ÿæ„å¤–é”™è¯¯
- `reason`Â â€”â€” å…³é—­åŸå› ï¼Œæ¯”å¦‚ â€œwork completeâ€

æˆ‘ä»¬å¯ä»¥åœ¨ `close`Â äº‹ä»¶ä¸­è·å–ä»–ä»¬ï¼š `event.code / event.reason`
### è¿æ¥çŠ¶æ€

è¦è·å–è¿æ¥çŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡å¸¦æœ‰å€¼çš„ socket.readyState å±æ€§ï¼š

- 0 â€”â€” â€œCONNECTINGâ€ï¼šè¿æ¥è¿˜æœªå»ºç«‹ï¼Œ
- 1 â€”â€” â€œOPENâ€ï¼šé€šä¿¡ä¸­ï¼Œ
- 2 â€”â€” â€œCLOSINGâ€ï¼šè¿æ¥å…³é—­ä¸­ï¼Œ
- 3 â€”â€” â€œCLOSEDâ€ï¼šè¿æ¥å·²å…³é—­ã€‚

## è¡¥å……ï¼šWeb Worker

> æ—¢ç„¶ä¸Šé¢æåˆ°äº† WebSocketï¼Œé‚£å°±é¡ºå¸¦æä¸€ä¸‹ Web Worker
>
> å…¶å®æ˜¯æˆ‘ä¹Ÿä¸çŸ¥é“åº”è¯¥æŠŠå®ƒæ”¾åœ¨å“ªä¸€å—å†…å®¹æ¯”è¾ƒåˆé€‚ğŸ™„

### 1. æ¦‚å¿µ

[Web Worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers) ä¸ºWebå†…å®¹åœ¨åå°çº¿ç¨‹ä¸­è¿è¡Œè„šæœ¬æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹æ³•ã€‚çº¿ç¨‹å¯ä»¥æ‰§è¡Œä»»åŠ¡è€Œä¸å¹²æ‰°ç”¨æˆ·ç•Œé¢ã€‚æ³¨æ„ï¼Œåœ¨workerå†…ï¼Œä¸èƒ½ç›´æ¥æ“ä½œDOMèŠ‚ç‚¹ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ window å¯¹è±¡çš„é»˜è®¤æ–¹æ³•å’Œå±æ€§ã€‚

### 2. æ–¹æ³•

å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š

- **index.html**

```javascript
<body>
  <div> è®¡æ•°: <output id="result">0</output></div>
  <button onclick="start()">å¼€å§‹worker</button>
  <button onclick="end()">ç»“æŸworker</button>
  <script>
    let worker
    function start() {
      // æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Web Worker
      if (typeof Worker === "undefined") {
        alert(`sor,br dont support`)
      } else {
        if (typeof worker == "undefined") {
          worker = new Worker("worker.js")
        }
        worker.onmessage = function (e) {
          result.textContent = e.data
        }
        worker.onerror = function(e){
          console.error(`é”™è¯¯ä¿¡æ¯ï¼š${e.message};é”™è¯¯è„šæœ¬ï¼š${e.filename};é”™è¯¯è¡Œå·ï¼š${e.lineno}`);
        }
      }
    }
    function end() {
      worker.terminate()
    }
  </script>
</body>
```

- **worker.js**

```javascript
let i = 0
function count() {
  if (++i == 10) close();
  postMessage(i)
  setTimeout(() => {
    count()
  }, 500)
}
count()
```

æ¥ä¸‹æ¥ç»“åˆä¸Šè¿°ä»£ç è¯´æ˜ä¸€äº›æ–¹æ³•ğŸ‘‡

#### æ£€æµ‹æµè§ˆå™¨æ˜¯å¦æ”¯æŒ Web Worker

```javascript
if(typeof Worker !== "undefined"){
    // æ˜¯çš„! Web worker æ”¯æŒ!
    // ä¸€äº›ä»£ç .....
}else{
    //æŠ±æ­‰! Web Worker ä¸æ”¯æŒ 
}
```

#### å¼€å¯ä¸€ä¸ª Web Worker

```javascript
if (typeof worker == "undefined") {
  worker = new Worker("worker.js")
}
```

#### worker å‘é€æ¶ˆæ¯

```javascript
postMessage(i)
```

#### æ¥æ”¶ message

ç”¨ `message` äº‹ä»¶æ¥æ”¶ï¼Œ `e.data` æ˜¯è·å–ä¼ æ¥çš„æ•°æ®

```javascript
 worker.onmessage = function (e) {
   result.textContent = e.data
 }
```

#### ç»ˆæ­¢ Web Worker

- åœ¨ä¸»çº¿ç¨‹ä¸Šç»“æŸ

å¦‚æœä½ éœ€è¦ä»ä¸»çº¿ç¨‹ä¸­ç«‹åˆ»ç»ˆæ­¢ä¸€ä¸ªè¿è¡Œä¸­çš„workerï¼Œå¯ä»¥è°ƒç”¨ worker çš„ [terminate](https://developer.mozilla.org/zh-CN/docs/Web/API/Worker) æ–¹æ³•ï¼Œworker çº¿ç¨‹ä¼šè¢«ç«‹å³æ€æ­»ï¼Œä¸ä¼šæœ‰ä»»ä½•æœºä¼šè®©å®ƒå®Œæˆè‡ªå·±çš„æ“ä½œæˆ–æ¸…ç†å·¥ä½œã€‚ï¼š

```javascript
worker.terminate()
```

- åœ¨ worker çº¿ç¨‹ä¸­ç»“æŸ

```javascript
close()
```

#### é”™è¯¯å¤„ç† error

- `message`  å¯è¯»æ€§è‰¯å¥½çš„é”™è¯¯æ¶ˆæ¯ã€‚
- `filename`  å‘ç”Ÿé”™è¯¯çš„è„šæœ¬æ–‡ä»¶åã€‚
- `lineno`  å‘ç”Ÿé”™è¯¯æ—¶æ‰€åœ¨è„šæœ¬æ–‡ä»¶çš„è¡Œå·ã€‚

```javascript
worker.onerror = function(e){
  console.error(`é”™è¯¯ä¿¡æ¯ï¼š${e.message};é”™è¯¯è„šæœ¬ï¼š${e.filename};é”™è¯¯è¡Œå·ï¼š${e.lineno}`);
}
```

