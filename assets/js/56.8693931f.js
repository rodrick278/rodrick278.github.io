(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{541:function(t,a,s){"use strict";s.r(a);var n=s(2),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"点击劫持-clickjacking"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#点击劫持-clickjacking"}},[t._v("#")]),t._v(" 点击劫持(ClickJacking)")]),t._v(" "),s("h3",{attrs:{id:"原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[t._v("#")]),t._v(" 原理")]),t._v(" "),s("p",[t._v("原理很简单，在网页的某一个可点击的元素上方，加上一个透明的 "),s("code",[t._v("<iframe>")]),t._v(" ，并置于顶层，然后用户点击元素的时候实际上会点击这个 "),s("code",[t._v("<iframe>")])]),t._v(" "),s("h3",{attrs:{id:"有效的防御措施"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#有效的防御措施"}},[t._v("#")]),t._v(" 有效的防御措施")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("X-Frame-Options")])])]),t._v(" "),s("p",[t._v("修改服务器 "),s("code",[t._v("header")]),t._v(" ，添加 "),s("code",[t._v("X-Frame-Options")]),t._v(" 响应头，有三种设置值：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("DENY")]),t._v("  —— 始终禁止在 frame 中显示此页面。")]),t._v(" "),s("li",[s("strong",[t._v("SAMEORIGIN")]),t._v(" —— 允许在和父文档同源的 frame 中显示此页面。")]),t._v(" "),s("li",[s("strong",[t._v("ALLOW-FROM "),s("domain")],1),t._v(" —— 允许在来自给定域 "),s("code",[t._v("domain")]),t._v(" 的父文档的 frame 中显示此页面。")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("protector  div")])])]),t._v(" "),s("p",[t._v("上面的 "),s("code",[t._v("X-Frame-Options")]),t._v(" 有一个问题是，别人的网页也无法用 "),s("code",[t._v("frame")]),t._v(" 引用我们的页面。")]),t._v(" "),s("p",[t._v("我们可以用一个样式为 "),s("strong",[t._v("height: 100%; width: 100%;")]),t._v("  的 "),s("code",[t._v("<div>")]),t._v(" “覆盖”页面，这样它就能拦截所有点击。如果 "),s("code",[t._v("window == top")]),t._v("  或者我们确定不需要保护时，再将该 "),s("code",[t._v("<div>")]),t._v("  移除。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("style"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  #protector "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    height"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    width"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    position"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" absolute"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    left"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    top"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    z"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("index"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("99999999")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("style"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div id"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"protector"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("a href"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/"')]),t._v(" target"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"_blank"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("前往网站"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("a"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果顶级窗口来自其他源，这里则会出现一个 error")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 但是在本例中没有问题")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("top"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domain "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    protector"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("remove")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("ul",[s("li",[s("strong",[t._v("samesite cookie")])])]),t._v(" "),s("p",[t._v("具有 "),s("code",[t._v("samesite")]),t._v("  特性的 cookie 仅在网站是通过直接方式打开（而不是通过 frame 或其他方式）的情况下才发送到网站。")]),t._v(" "),s("h2",{attrs:{id:"xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xss"}},[t._v("#")]),t._v(" XSS")]),t._v(" "),s("h3",{attrs:{id:"什么是-xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是-xss"}},[t._v("#")]),t._v(" 什么是 XSS")]),t._v(" "),s("p",[t._v("Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全")]),t._v(" "),s("h3",{attrs:{id:"xss-分类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xss-分类"}},[t._v("#")]),t._v(" XSS 分类")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("类型")]),t._v(" "),s("th",[t._v("存储区")]),t._v(" "),s("th",[t._v("插入点")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("存储型 XSS")]),t._v(" "),s("td",[t._v("后端数据库")]),t._v(" "),s("td",[t._v("HTML")])]),t._v(" "),s("tr",[s("td",[t._v("反射型 XSS")]),t._v(" "),s("td",[t._v("URL")]),t._v(" "),s("td",[t._v("HTML")])]),t._v(" "),s("tr",[s("td",[t._v("DOM 型 XSS")]),t._v(" "),s("td",[t._v("后端数据库/前端存储/URL")]),t._v(" "),s("td",[t._v("前端 JavaScript")])])])]),t._v(" "),s("h4",{attrs:{id:"存储型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#存储型"}},[t._v("#")]),t._v(" 存储型")]),t._v(" "),s("ol",[s("li",[t._v("恶意代码被存入 "),s("strong",[t._v("数据库")])]),t._v(" "),s("li",[t._v("用户打开网页后代码被 "),s("strong",[t._v("服务端")]),t._v(" 取出返回给客户端")]),t._v(" "),s("li",[t._v("客户端浏览器解析响应恶意代码")])]),t._v(" "),s("p",[t._v("这种攻击常见于带有 "),s("strong",[t._v("用户保存数据的网站功能")]),t._v(" ，如论坛发帖、商品评论、用户私信等。")]),t._v(" "),s("h4",{attrs:{id:"反射型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#反射型"}},[t._v("#")]),t._v(" 反射型")]),t._v(" "),s("ol",[s("li",[t._v("攻击者伪造 "),s("strong",[t._v("特殊 URL")])]),t._v(" "),s("li",[t._v("用户打开恶意 URL， "),s("strong",[t._v("服务端")]),t._v(" 将恶意代码从 URL 中取出（参数等），拼接进 HTML")]),t._v(" "),s("li",[t._v("恶意代码被响应，窃取信息，冒充用户行为")])]),t._v(" "),s("p",[t._v("常见于 "),s("strong",[t._v("通过 URL 传递参数")]),t._v(" 的功能，如网站搜索、跳转等，诱导用户主动打开恶意 URL。\n"),s("strong",[t._v("POST 方式也可以触发反射型 XSS")]),t._v(" ，但是需要构造表单提交页面，并引导用户点击。")]),t._v(" "),s("h4",{attrs:{id:"dom-型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dom-型"}},[t._v("#")]),t._v(" DOM 型")]),t._v(" "),s("ol",[s("li",[t._v("攻击者构造出 "),s("strong",[t._v("特殊的 URL")]),t._v(" ，其中包含恶意代码。")]),t._v(" "),s("li",[t._v("用户打开带有恶意代码的 URL。")]),t._v(" "),s("li",[t._v("用户浏览器接收到响应后解析执行， "),s("strong",[t._v("前端 JavaScript 取出 URL 中的恶意代码并执行")]),t._v(" 。")]),t._v(" "),s("li",[t._v("恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。")])]),t._v(" "),s("p",[s("strong",[t._v("DOM 型是属于前端 JavaScript 的安全漏洞，前两种是服务端的安全漏洞")])]),t._v(" "),s("h3",{attrs:{id:"防御-xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防御-xss"}},[t._v("#")]),t._v(" 防御 XSS")]),t._v(" "),s("h4",{attrs:{id:"不靠谱的输入过滤"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#不靠谱的输入过滤"}},[t._v("#")]),t._v(" 不靠谱的输入过滤")]),t._v(" "),s("p",[s("strong",[t._v("Q")]),t._v("：用户提交时，由前端过滤输入，然后提交到后端。这样做是否可行？\n"),s("strong",[t._v("A")]),t._v("：不可行。一旦攻击者绕过前端过滤，直接构造请求，就可以提交恶意代码了\n"),s("strong",[t._v("Q")]),t._v("：后端在写入数据库前，对输入进行过滤，然后把“安全的”内容，返回给前端。这样是否可行呢？\n"),s("strong",[t._v("A")]),t._v("：我们举一个例子：\n一个正常的用户输入了 "),s("code",[t._v("5 < 7")]),t._v(" 这个内容，在写入数据库前，被转义，变成了 "),s("code",[t._v("5 &lt; 7")]),t._v("。\n问题是：在提交阶段，我们并不确定内容要输出到哪里。")]),t._v(" "),s("p",[t._v("这里的“并不确定内容要输出到哪里”有两层含义：")]),t._v(" "),s("ol",[s("li",[t._v("用户的输入内容可能同时提供给前端和客户端，而一旦经过了 "),s("code",[t._v("escapeHTML()")]),t._v("，客户端显示的内容就变成了乱码( "),s("code",[t._v("5 &lt; 7")]),t._v(" )。")]),t._v(" "),s("li",[t._v("在前端中，不同的位置所需的编码也不同。")])]),t._v(" "),s("ul",[s("li",[t._v("当 "),s("code",[t._v("5 &lt; 7")]),t._v(" 作为 HTML 拼接页面时，可以正常显示：")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('<div title="comment">5 &lt; 7</div>\n')])])]),s("ul",[s("li",[t._v("当 "),s("code",[t._v("5 &lt; 7")]),t._v("  通过 Ajax 返回，然后赋值给 JavaScript 的变量时，前端得到的字符串就是转义后的字符。这个内容不能直接用于 Vue 等模板的展示，也不能直接用于内容长度计算。不能用于标题、alert 等。")])]),t._v(" "),s("p",[s("strong",[t._v("所以，对于明确的输入输出场合，可以使用，但是不确定输出场合的话，这个方法并不可靠")])]),t._v(" "),s("h4",{attrs:{id:"no-1-预防存储型和反射型-xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#no-1-预防存储型和反射型-xss"}},[t._v("#")]),t._v(" No.1 预防存储型和反射型 XSS")]),t._v(" "),s("p",[t._v("由于这两种 XSS 都是服务端取出恶意代码，所以我们可以用如下两种方案：")]),t._v(" "),s("p",[s("strong",[t._v("一、纯前端渲染")]),t._v(" \n不使用 SSR 方案，完全前后端分离，使用 Ajax 调用数据。\n在学习 Vue 的 "),s("code",[t._v("v-html")]),t._v(" 指令时，官方文档有这么一段话")]),t._v(" "),s("blockquote",[s("p",[t._v("Dynamically rendering arbitrary HTML on your website can be very dangerous because it can easily lead to "),s("a",{attrs:{href:"https://en.wikipedia.org/wiki/Cross-site_scripting",target:"_blank",rel:"noopener noreferrer"}},[t._v("XSS attacks"),s("OutboundLink")],1),t._v(". Only use v-html on trusted content and never on user-provided content.\n在你的网站上动态渲染任意的HTML是非常危险的，因为它很容易导致XSS攻击。只在可信的内容上使用v-html，永远不要在用户提供的内容上使用。")])]),t._v(" "),s("p",[t._v("但是在对于性能要求高，或有SEO需求的页面，我们仍然会有拼接 HTML 的问题。")]),t._v(" "),s("p",[s("strong",[t._v("二、转义 HTML")]),t._v(" \n如果拼接 HTML 是必要的，就需要采用合适的转义库，对 HTML 模板各处插入点进行充分的转义。\n常用的模板引擎，如 doT.js、ejs、FreeMarker 等，对于 HTML 转义通常只有一个规则，就是把 "),s("code",[t._v("& < > \" ' /")]),t._v(" 这几个字符转义掉，确实能起到一定的 XSS 防护作用，但并不完善：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[s("strong",[t._v("XSS 安全漏洞")])]),t._v(" "),s("th",[s("strong",[t._v("简单转义是否有防护作用")])])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("HTML 标签文字内容")]),t._v(" "),s("td",[t._v("有")])]),t._v(" "),s("tr",[s("td",[t._v("HTML 属性值")]),t._v(" "),s("td",[t._v("有")])]),t._v(" "),s("tr",[s("td",[t._v("CSS 内联样式")]),t._v(" "),s("td",[t._v("无")])]),t._v(" "),s("tr",[s("td",[t._v("内联 JavaScript")]),t._v(" "),s("td",[t._v("无")])]),t._v(" "),s("tr",[s("td",[t._v("内联 JSON")]),t._v(" "),s("td",[t._v("无")])]),t._v(" "),s("tr",[s("td",[t._v("跳转链接")]),t._v(" "),s("td",[t._v("无")])])])]),t._v(" "),s("p",[t._v("所以要完善 XSS 防护措施，我们要使用更完善更细致的转义策略。\n例如 Java 工程里，常用的转义库为 "),s("code",[t._v("org.owasp.encoder")]),t._v("。以下代码引用自 "),s("a",{attrs:{href:"https://www.owasp.org/index.php/OWASP_Java_Encoder_Project#tab=Use_the_Java_Encoder_Project",target:"_blank",rel:"noopener noreferrer"}},[t._v("org.owasp.encoder 的官方说明"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- HTML 标签内文字内容 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("<%= Encode.forHtml(UNTRUSTED) %>"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- HTML 标签属性值 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("<%= Encode.forHtml(UNTRUSTED) %>"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- CSS 属性值 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token style-attr language-css"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('="')]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("width")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("<= Encode."),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forCssString")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UNTRUSTED"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" %>")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- CSS URL --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),s("span",{pre:!0,attrs:{class:"token style-attr language-css"}},[s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("style")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('="')]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token property"}},[t._v("background")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("<= Encode."),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("forCssUrl")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("UNTRUSTED"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" %>")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- JavaScript 内联代码块 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" msg "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<%= Encode.forJavaScript(UNTRUSTED) %>"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("msg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- JavaScript 内联代码块内嵌 JSON --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" __INITIAL_STATE__ "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'<%= Encoder.forJavaScript(data.to_json) %>'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- HTML 标签内联监听器 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("button")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onclick")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("alert("),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("<%= Encode.forJavaScript(UNTRUSTED) %>"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v(");"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  click me\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("button")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- URL 参数 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("/search?value=<%= Encode.forUriComponent(UNTRUSTED) %>&order=1#top"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- URL 路径 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("/page/<%= Encode.forUriComponent(UNTRUSTED) %>"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('\x3c!--\n  URL.\n  注意：要根据项目情况进行过滤，禁止掉 "javascript:" 链接、非法 scheme 等\n--\x3e')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("<%=\n  urlValidator.isValid(UNTRUSTED) ?\n    Encode.forHtml(UNTRUSTED) :\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("/404"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("\n%>"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  link\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("a")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("可见，HTML 的编码是十分复杂的，在不同的上下文里要使用相应的转义规则。")]),t._v(" "),s("h4",{attrs:{id:"no-2-预防-dom-型-xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#no-2-预防-dom-型-xss"}},[t._v("#")]),t._v(" No.2 预防 DOM 型 XSS")]),t._v(" "),s("p",[t._v("DOM 型的 XSS ，是由于前端的防范漏洞造成的。")]),t._v(" "),s("ul",[s("li",[t._v("使用会写入 HTML 片段的方法时要特别小心，不要把，比如 "),s("code",[t._v("innerHTML")]),t._v(" 、 "),s("code",[t._v("outerHTML")]),t._v(" 、 "),s("code",[t._v("document.write")]),t._v(" ，尽量使用 "),s("code",[t._v("textContent")]),t._v(" 、 "),s("code",[t._v("setAttribute()")]),t._v(" 等")]),t._v(" "),s("li",[t._v("如果用 Vue/React 技术栈，并且不使用 "),s("code",[t._v("v-html/dangerouslySetInnerHTML")]),t._v("  功能，就在前端 render 阶段避免 "),s("code",[t._v("innerHTML")]),t._v(" 、 "),s("code",[t._v("outerHTML")]),t._v("  的 XSS 隐患。")]),t._v(" "),s("li",[t._v("DOM 中的内联事件监听器，如 "),s("code",[t._v("location")]),t._v("、"),s("code",[t._v("onclick")]),t._v("、"),s("code",[t._v("onerror")]),t._v("、"),s("code",[t._v("onload")]),t._v("、"),s("code",[t._v("onmouseover")]),t._v(" 等，"),s("code",[t._v("<a>")]),t._v(" 标签的 "),s("code",[t._v("href")]),t._v(" 属性，JavaScript 的 "),s("code",[t._v("eval()")]),t._v("、"),s("code",[t._v("setTimeout()")]),t._v("、"),s("code",[t._v("setInterval()")]),t._v(" 等，都能把字符串作为代码运行。如果不可信的数据拼接到字符串中传递给这些 API，很容易产生安全隐患，请务必避免。")])]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- 内联事件监听器中包含恶意代码 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("img")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onclick")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("UNTRUSTED"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("onerror")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("UNTRUSTED"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("data:image/png,"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- 链接内包含恶意代码 --\x3e")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("a")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("UNTRUSTED"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("a")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// setTimeout()/setInterval() 中调用恶意代码")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UNTRUSTED"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UNTRUSTED"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// location 调用恶意代码")]),t._v("\nlocation"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("href "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'UNTRUSTED'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// eval() 中调用恶意代码")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("eval")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UNTRUSTED"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n")])])]),s("h3",{attrs:{id:"其他防御措施"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他防御措施"}},[t._v("#")]),t._v(" 其他防御措施")]),t._v(" "),s("h4",{attrs:{id:"content-security-policy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#content-security-policy"}},[t._v("#")]),t._v(" Content Security Policy")]),t._v(" "),s("p",[t._v("严格的 CSP 在 XSS 的防范中可以起到以下的作用：")]),t._v(" "),s("ul",[s("li",[t._v("禁止加载外域代码，防止复杂的攻击逻辑。")]),t._v(" "),s("li",[t._v("禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。")]),t._v(" "),s("li",[t._v("禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。")]),t._v(" "),s("li",[t._v("禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。")]),t._v(" "),s("li",[t._v("合理使用上报可以及时发现 XSS，利于尽快修复问题。")])]),t._v(" "),s("h4",{attrs:{id:"输入内容长度控制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#输入内容长度控制"}},[t._v("#")]),t._v(" 输入内容长度控制")]),t._v(" "),s("p",[t._v("对于不受信任的输入，都应该限定一个合理的长度。虽然无法完全防止 XSS 发生，但可以增加 XSS 攻击的难度。")]),t._v(" "),s("h4",{attrs:{id:"其他安全措施"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他安全措施"}},[t._v("#")]),t._v(" 其他安全措施")]),t._v(" "),s("ul",[s("li",[t._v("HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie，攻击者完成 XSS 注入后也无法窃取此 Cookie。")]),t._v(" "),s("li",[t._v("验证码：防止脚本冒充用户提交危险操作。")])]),t._v(" "),s("h3",{attrs:{id:"检测-xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检测-xss"}},[t._v("#")]),t._v(" 检测 XSS")]),t._v(" "),s("p",[t._v("两个方法：")]),t._v(" "),s("ol",[s("li",[t._v("使用通用 XSS 攻击字符串手动检测 XSS 漏洞。")]),t._v(" "),s("li",[t._v("使用扫描工具自动检测 XSS 漏洞。")])]),t._v(" "),s("p",[t._v("参考 "),s("a",{attrs:{href:"https://github.com/0xsobky/HackVault/wiki/Unleashing-an-Ultimate-XSS-Polyglot",target:"_blank",rel:"noopener noreferrer"}},[t._v("Unleashing an Ultimate XSS Polyglot"),s("OutboundLink")],1),t._v(" 一文中，使用如下字符串：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("jaVasCript:/*-/*`/*\\`/*'/*\"/**/(/* */oNcliCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/<\/scRipt/--!>\\x3csVg/<sVg/oNloAd=alert()//>\\x3e\n")])])]),s("p",[t._v("它能够检测到存在于 HTML 属性、HTML 文字内容、HTML 注释、跳转链接、内联 JavaScript 字符串、内联 CSS 样式表等多种上下文中的 XSS 漏洞，也能检测 "),s("code",[t._v("eval()")]),t._v("、"),s("code",[t._v("setTimeout()")]),t._v("、"),s("code",[t._v("setInterval()")]),t._v("、"),s("code",[t._v("Function()")]),t._v("、"),s("code",[t._v("innerHTML")]),t._v("、"),s("code",[t._v("document.write()")]),t._v(" 等 DOM 型 XSS 漏洞，并且能绕过一些 XSS 过滤器。")]),t._v(" "),s("p",[t._v("除了手动检测之外，还可以使用自动扫描工具寻找 XSS 漏洞，例如 "),s("a",{attrs:{href:"https://github.com/Arachni/arachni",target:"_blank",rel:"noopener noreferrer"}},[t._v("Arachni"),s("OutboundLink")],1),t._v("、"),s("a",{attrs:{href:"https://github.com/mozilla/http-observatory/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Mozilla HTTP Observatory"),s("OutboundLink")],1),t._v("、"),s("a",{attrs:{href:"https://github.com/andresriancho/w3af",target:"_blank",rel:"noopener noreferrer"}},[t._v("w3af"),s("OutboundLink")],1),t._v(" 等。")]),t._v(" "),s("h2",{attrs:{id:"csrf"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#csrf"}},[t._v("#")]),t._v(" CSRF")]),t._v(" "),s("h3",{attrs:{id:"csrf-概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#csrf-概念"}},[t._v("#")]),t._v(" CSRF 概念")]),t._v(" "),s("p",[t._v("CSRF（Cross-site request forgery）跨站请求伪造：攻击者诱导受害者进入第三方网站，在第三方网站中，向被攻击网站发送跨站请求。利用受害者在被攻击网站已经获取的注册凭证，绕过后台的用户验证，达到冒充用户对被攻击的网站执行某项操作的目的。\n一个典型的CSRF攻击有着如下的流程：")]),t._v(" "),s("ul",[s("li",[t._v("受害者登录a.com，并保留了登录凭证（Cookie）。")]),t._v(" "),s("li",[t._v("攻击者引诱受害者访问了b.com。")]),t._v(" "),s("li",[t._v("b.com 向 a.com 发送了一个请求：a.com/act=xx。浏览器会览器会默认携带a.com的Cookie。")]),t._v(" "),s("li",[t._v("a.com接收到请求后，对请求进行验证，并确认是受害者的凭证，误以为是受害者自己发送的请求。")]),t._v(" "),s("li",[t._v("a.com以受害者的名义执行了act=xx。")]),t._v(" "),s("li",[t._v("攻击完成，攻击者在受害者不知情的情况下，冒充受害者，让a.com执行了自己定义的操作")])]),t._v(" "),s("h3",{attrs:{id:"常见攻击类型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常见攻击类型"}},[t._v("#")]),t._v(" 常见攻击类型")]),t._v(" "),s("ul",[s("li",[t._v("GET 类型")])]),t._v(" "),s("p",[t._v("GET类型的CSRF利用非常简单，只需要一个HTTP请求，一般会这样利用：")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("img")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://bank.example/withdraw?amount=10000&for=hacker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("受害者访问包含这个 img 的页面时，浏览器会自动向 "),s("code",[t._v("bank.example")]),t._v(" 发送一个 HTTP 请求， "),s("code",[t._v("bank.example")]),t._v(" 就会收到包含受害者信息（cookie 等）的一次跨域请求")]),t._v(" "),s("ul",[s("li",[t._v("POST 类型")])]),t._v(" "),s("p",[t._v("这种类型的CSRF利用起来通常使用的是一个自动提交的表单，如：")]),t._v(" "),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("form")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("action")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://bank.example/withdraw"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("method")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),t._v("POST")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hidden"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("account"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("xiaoming"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hidden"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("amount"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("10000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hidden"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("for"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("hacker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("form")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token script"}},[s("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v(" document"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("forms"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("submit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" ")])]),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" \n")])])]),s("p",[t._v("访问该页面后，表单会自动提交，相当于模拟用户完成了一次POST操作。")]),t._v(" "),s("ul",[s("li",[t._v("链接型")])]),t._v(" "),s("p",[t._v("链接类型，其实就是诱导用户点击恶意链接，这种比较少见。")]),t._v(" "),s("h3",{attrs:{id:"csrf-的特点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#csrf-的特点"}},[t._v("#")]),t._v(" CSRF 的特点")]),t._v(" "),s("ul",[s("li",[t._v("攻击"),s("strong",[t._v("一般发起在第三方网站")]),t._v("，而不是被攻击的网站。被攻击的网站无法防止攻击发生。")]),t._v(" "),s("li",[t._v("攻击利用受害者在被攻击网站的登录凭证，"),s("strong",[t._v("冒充")]),t._v("受害者提交操作；而"),s("strong",[t._v("不是直接窃取数据")]),t._v("。")]),t._v(" "),s("li",[t._v("整个过程攻击者并不能获取到受害者的登录凭证，仅仅是“"),s("strong",[t._v("冒用")]),t._v("”。")]),t._v(" "),s("li",[t._v("跨站请求可以用各种方式：图片URL、超链接、CORS、Form提交等等。部分请求方式可以直接嵌入在第三方论坛、文章中，难以进行追踪。")])]),t._v(" "),s("p",[t._v("CSRF"),s("strong",[t._v("通常是跨域")]),t._v("的，因为外域通常更容易被攻击者掌控。但是如果本域下有容易被利用的功能，比如可以发图和链接的论坛和评论区，攻击可以直接在本域下进行，而且这种攻击更加危险。")]),t._v(" "),s("h3",{attrs:{id:"防护策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防护策略"}},[t._v("#")]),t._v(" 防护策略")]),t._v(" "),s("p",[t._v("关于防护策略，主要有两种方式：")]),t._v(" "),s("ul",[s("li",[t._v("阻止不明外域的访问\n"),s("ul",[s("li",[t._v("同源检测")]),t._v(" "),s("li",[t._v("Samesite Cookie")])])]),t._v(" "),s("li",[t._v("提交时要求附加本域才能获取的信息\n"),s("ul",[s("li",[t._v("CSRF Token")]),t._v(" "),s("li",[t._v("双重Cookie验证")])])])]),t._v(" "),s("h4",{attrs:{id:"同源检测"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#同源检测"}},[t._v("#")]),t._v(" 同源检测")]),t._v(" "),s("p",[t._v("在跨域请求中，浏览器会自动添加 "),s("code",[t._v("Origin Header")]),t._v(" 、 "),s("code",[t._v("Referer Header")]),t._v(" 用来标记来源域名，服务器可以通过解析 Header 中的域名来确定请求源。")]),t._v(" "),s("p",[s("strong",[t._v("Origin Header 在两种情况下不存在")]),t._v(" ：")]),t._v(" "),s("ul",[s("li",[t._v("**IE11 同源策略：**IE 11 不会在跨站CORS请求上添加Origin标头，Referer头将仍然是唯一的标识。")]),t._v(" "),s("li",[t._v("**302重定向：**在302重定向之后Origin不包含在重定向的请求中，因为Origin可能会被认为是其他来源的敏感信息。")])]),t._v(" "),s("p",[t._v("但是，当一个请求是页面请求（比如网站的主页），而来源是"),s("strong",[t._v("搜索引擎的链接")]),t._v("（例如百度的搜索结果），"),s("strong",[t._v("也会被当成疑似CSRF攻击")]),t._v("。\n而且，CSRF大多数情况下来自第三方域名，但"),s("strong",[t._v("并不能排除本域发起")]),t._v("。如果攻击者有权限在本域发布评论（含链接、图片等，统称UGC），那么它可以直接在本域发起攻击，这种情况下同源策略无法达到防护的作用。")]),t._v(" "),s("h4",{attrs:{id:"csrf-token"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#csrf-token"}},[t._v("#")]),t._v(" CSRF Token")]),t._v(" "),s("p",[t._v("CSRF的另一个特征是，攻击者"),s("strong",[t._v("无法直接窃取到用户的信息")]),t._v("（Cookie，Header，网站内容等），仅仅是冒用Cookie中的信息。\n那么我们可以利用这一点，将所有的用户请求都携带一个攻击者无法拿到的 Token ，服务器通过验证这个 Token 来判断是否被 CSRF")]),t._v(" "),s("ol",[s("li",[t._v("用户打开页面的时候，服务器生成一个加密过的 token，token "),s("strong",[t._v("不能放在 cookie 中")]),t._v("，否则依旧会被盗用，可以放在服务器的 Session 中")]),t._v(" "),s("li",[t._v("页面加载的时候，js 遍历 DOM 树，给 a 标签，form 标签加上 token")]),t._v(" "),s("li",[t._v("页面加载后动态生成的 HTML，需要手动添加 token")]),t._v(" "),s("li",[t._v("页面提交的请求的时候，携带这个 token，以便后台验证。GET 请求直接加上参数，POST 的 form 加一个 hidden input")])]),t._v(" "),s("div",{staticClass:"language-HTML extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),t._v("”hidden”")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),t._v("”csrftoken”")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),t._v("”tokenvalue”/")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("但是这种方式有一些"),s("strong",[t._v("弊端")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("在 "),s("strong",[t._v("分布式集群")]),t._v(" 中，由于 Session 默认存储在单机服务器内存中，因此在分布式环境下同一个用户发送的多次 HTTP 请求可能会先后落到不同的服务器上，导致"),s("strong",[t._v("后面发起的 HTTP 请求无法拿到之前的 HTTP 请求存储在服务器中的 Session 数据")]),t._v("，因此分布式集群中可能需要用到 Redis 等公共空间来存储")]),t._v(" "),s("li",[t._v("后端需要对每个接口进行 token 验证，"),s("strong",[t._v("工作量很大且容易遗漏")])]),t._v(" "),s("li",[t._v("如果"),s("strong",[t._v("同时被 XSS 攻击")]),t._v(" ，攻击者先发起一次，用跨域方法绕过同源策略，就可以读取目标网站的 Token，甚至拿到 cookie")])]),t._v(" "),s("h4",{attrs:{id:"双重-cookie-验证"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#双重-cookie-验证"}},[t._v("#")]),t._v(" 双重 Cookie 验证")]),t._v(" "),s("p",[t._v("根据 CSRF 攻击不能获取到用户 Cookie 的特点，我们使用如下方法：")]),t._v(" "),s("ol",[s("li",[t._v("用户访问网页时，像请求的域名注入一个随机字符串 cookie，比如 "),s("code",[t._v("csrfcookie=qwer")])]),t._v(" "),s("li",[t._v("在正常发起请求时，取出这个 cookie，拼接到参数中 "),s("code",[t._v("POST https://www.a.com/comment?csrfcookie=qwer")])]),t._v(" "),s("li",[t._v("后端验证是否参数与 cookie 中的字段是否一致")])]),t._v(" "),s("p",[t._v("但是这个也有 "),s("strong",[t._v("弊端")]),t._v(" ：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("任何跨域在没有设置都会导致前端无法获取 cookie 中的字段")]),t._v("，"),s("strong",[t._v("而在 cookie 没有设置")]),t._v(" "),s("a",{attrs:{href:"https://zh.javascript.info/cookie#domain",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("domain")]),s("OutboundLink")],1),t._v("  属性的时候，"),s("strong",[t._v("子域也无法拿到 cookie")]),t._v("。比如 "),s("code",[t._v("a.com")]),t._v(" 向 "),s("code",[t._v("api.a.com")]),t._v(" 发请求。")]),t._v(" "),s("li",[t._v("而如果设置了 "),s("code",[t._v("domain")]),t._v(" 属性，然后子域 "),s("code",[t._v("api.a.com")]),t._v(" 被 "),s("strong",[t._v("XSS 攻击")]),t._v(" 了，那么对方就可以拿到我们的 cookie。")])]),t._v(" "),s("h4",{attrs:{id:"samesite-cookie-属性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#samesite-cookie-属性"}},[t._v("#")]),t._v(" "),s("a",{attrs:{href:"https://zh.javascript.info/cookie#samesite",target:"_blank",rel:"noopener noreferrer"}},[t._v("samesite"),s("OutboundLink")],1),t._v(" Cookie 属性")]),t._v(" "),s("p",[s("strong",[t._v("一、samesite = strict")])]),t._v(" "),s("p",[t._v("只要是来自非同一网站，那么设置了 "),s("code",[t._v("samesite=strict")]),t._v(" 的 cookie，一定不会被发送")]),t._v(" "),s("p",[s("strong",[t._v("二、samesite = lax")])]),t._v(" "),s("p",[t._v("假如这个请求是这种请求（改变了当前页面或者打开了新页面）且同时是个GET请求，则这个Cookie可以作为第三方Cookie。")]),t._v(" "),s("p",[t._v("举个例子， "),s("code",[t._v("a.com")]),t._v(" 向 "),s("code",[t._v("b.com")]),t._v(" 发送了一个请求， "),s("code",[t._v("b.com")]),t._v(" 有如下 cookie")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Set-Cookie: foo=1; Samesite=Strict\nSet-Cookie: bar=2; Samesite=Lax\nSet-Cookie: baz=3\n")])])]),s("p",[t._v("当用户从 "),s("code",[t._v("a.com")]),t._v(" 点击链接进入 "),s("code",[t._v("b.com")]),t._v(" 时，foo 这个 Cookie 不会被包含在 Cookie response 请求头中，但 bar 和 baz 会，也就是说用户在不同网站之间通过链接跳转是不受影响了。但假如这个请求是从 "),s("code",[t._v("a.com")]),t._v(" 发起的对 "),s("code",[t._v("b.com")]),t._v(" 的异步请求，或者页面跳转是通过表单的 post 提交触发的，则 bar 也不会发送。")]),t._v(" "),s("h3",{attrs:{id:"防止网站被利用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#防止网站被利用"}},[t._v("#")]),t._v(" 防止网站被利用")]),t._v(" "),s("p",[t._v("对于来自黑客自己的网站，我们无法防护。但对其他情况，那么如何防止自己的网站被利用成为攻击的源头呢？")]),t._v(" "),s("ul",[s("li",[t._v("严格管理所有的上传接口，防止任何预期之外的上传内容（例如HTML）。")]),t._v(" "),s("li",[t._v("添加Header "),s("code",[t._v("X-Content-Type-Options: nosniff")]),t._v(" 防止黑客上传HTML内容的资源（例如图片）被解析为网页。")]),t._v(" "),s("li",[t._v("对于用户上传的图片，进行转存或者校验。不要直接使用用户填写的图片链接。")]),t._v(" "),s("li",[t._v("当前用户打开其他用户填写的链接时，需告知风险（这也是很多论坛不允许直接在内容中发布外域链接的原因之一，不仅仅是为了用户留存，也有安全考虑）。")])])])}),[],!1,null,null,null);a.default=e.exports}}]);