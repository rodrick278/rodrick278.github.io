(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{553:function(e,t,a){"use strict";a.r(t);var r=a(2),n=Object(r.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("背景")]),e._v(" "),a("p",[e._v("由于 "),a("code",[e._v("LeanCloud")]),e._v(" 的各种“你懂的”的原因，现在国内节点需要备案等等限制")]),e._v(" "),a("p",[e._v("加上自己又想白嫖 "),a("code",[e._v("LeanCloud")]),e._v(" 来实现浏览量+评论管理+邮件通知一条龙服务")]),e._v(" "),a("p",[e._v("网上也没有很好的综合文档，所以这里整理一份完整的操作步骤")])]),e._v(" "),a("h2",{attrs:{id:"_20200926-更新"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_20200926-更新"}},[e._v("#")]),e._v(" 20200926 更新")]),e._v(" "),a("blockquote",[a("p",[e._v("国内大量使用国际版LeanCloud后端的博客的Valine评论一齐失效")]),e._v(" "),a("p",[e._v("通过"),a("a",{attrs:{href:"https://github.com/xCss/Valine/issues/340",target:"_blank",rel:"noopener noreferrer"}},[e._v("Valine的Github的Issue"),a("OutboundLink")],1),e._v("得知，早在5月份LeanCloud官方就低调表示us.avoscloud.com域名将于不久后下线。")]),e._v(" "),a("p",[e._v("参考上方的讨论办法，现在如果使用国际版LeanCloud作为Valine评论的后端的话则必须指定自定义服务器URL才能正常使用了。")]),e._v(" "),a("p",[e._v("自定义服务器的URL需要到LeanCloud后台查看。打开后台之后进入Settings - App Keys，找到Domain whitelist，里面的Request domain里面的那个xxxxxxxx.api.lncldglobal.com就是你需要指定的服务器URL。其中xxxxxxxx就是各位的AppID的前8位字符。")]),e._v(" "),a("p",[e._v("然后再 "),a("code",[e._v("config.js")]),e._v(" 里加上 "),a("code",[e._v("serverURLs:'https://xxxxx.api.lncldglobal.com',")]),e._v(" 即可")])]),e._v(" "),a("hr"),e._v(" "),a("h1",{attrs:{id:"参考来源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考来源"}},[e._v("#")]),e._v(" 参考来源")]),e._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://valine.js.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Valine"),a("OutboundLink")],1),e._v(" ：评论管理系统")]),e._v(" "),a("p",[a("a",{attrs:{href:"http://www.zhaojun.im/hexo-valine-admin/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Valine-Admin"),a("OutboundLink")],1),e._v("："),a("code",[e._v("Valine v1.4.0")]),e._v(" 之后已经去除了邮件提醒功能，所以我们这里使用 "),a("code",[e._v("Valine-Admin")]),e._v(" by "),a("a",{attrs:{href:"https://github.com/zhaojun1998/Valine-Admin",target:"_blank",rel:"noopener noreferrer"}},[e._v("@zhaojun1998"),a("OutboundLink")],1)]),e._v(" "),a("p",[a("a",{attrs:{href:"https://www.antmoe.com/posts/ff6aef7b/",target:"_blank",rel:"noopener noreferrer"}},[e._v("LeanCloud流控原因的解决方案"),a("OutboundLink")],1),e._v("：由于白嫖党过多导致的官方限流解决方案")])]),e._v(" "),a("h1",{attrs:{id:"开始"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开始"}},[e._v("#")]),e._v(" 开始")]),e._v(" "),a("h3",{attrs:{id:"_1-打开leancloud-官网-注册账号"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-打开leancloud-官网-注册账号"}},[e._v("#")]),e._v(" 1. 打开"),a("a",{attrs:{href:"https://console.leancloud.app/",target:"_blank",rel:"noopener noreferrer"}},[a("code",[e._v("LeanCloud")]),a("OutboundLink")],1),e._v(" 官网，注册账号")]),e._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/rodrick278/img/raw/master/img/image-20200911183531065.png",alt:"image-20200911183531065"}}),e._v(" "),a("h3",{attrs:{id:"_2-登陆"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-登陆"}},[e._v("#")]),e._v(" 2. 登陆")]),e._v(" "),a("p",[e._v("登陆之后右上角选择 "),a("strong",[e._v("国际版")]),e._v("【"),a("strong",[e._v("如果你的域名备过案了就选个正常节点就行，但是没备案的或者使用ghpages这种的，请选择国际版")]),e._v("】，然后创建新的应用")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/rodrick278/img/raw/master/img/image-20200911183742658.png",alt:"image-20200911183742658"}})]),e._v(" "),a("h3",{attrs:{id:"_3-应用创建后"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-应用创建后"}},[e._v("#")]),e._v(" 3. 应用创建后")]),e._v(" "),a("p",[e._v("应用创建好以后，进入刚刚创建的应用，选择左下角的"),a("code",[e._v("设置")]),e._v(">"),a("code",[e._v("应用Key")]),e._v(",找到你的"),a("code",[e._v("APP ID")]),e._v("和"),a("code",[e._v("APP Key")]),e._v(",然后填入我们项目的 "),a("code",[e._v("config.js")])]),e._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/rodrick278/img/raw/master/img/image-20200911184026702.png",alt:"image-20200911184026702"}}),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v(" valineConfig"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n      appId"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'xxxxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// your appId")]),e._v("\n      appKey"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'xxxxxx'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// your appKey")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("h3",{attrs:{id:"_4-valine-admin-的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-valine-admin-的配置"}},[e._v("#")]),e._v(" 4. "),a("code",[e._v("valine-admin")]),e._v(" 的配置")]),e._v(" "),a("p",[e._v("这段不做详细介绍，参见"),a("a",{attrs:{href:"http://www.zhaojun.im/hexo-valine-admin/",target:"_blank",rel:"noopener noreferrer"}},[e._v("官方说明"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("要注意的几个点：")]),e._v(" "),a("ul",[a("li",[e._v("记得在 设置->域名绑定->云引擎、ClientEngine 域名 这里绑定你的域名，这就是为什么要选个国际版，因为没国内节点没备案你是过不了审的")]),e._v(" "),a("li",[e._v("部署填写代码库直接是在 云引擎->部署页面最下面的"),a("code",[e._v("Git部署")])])]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Leancloud 休眠策略【重要】")]),e._v(" "),a("p",[e._v("首先按照大佬给的"),a("a",{attrs:{href:"https://github.com/zhaojun1998/Valine-Admin/blob/master/%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE.md#leancloud-%E4%BC%91%E7%9C%A0%E7%AD%96%E7%95%A5",target:"_blank",rel:"noopener noreferrer"}},[e._v("教程"),a("OutboundLink")],1),e._v("如下：")]),e._v(" "),a("p",[e._v("免费版的 LeanCloud 容器，是有强制性休眠策略的，不能 24 小时运行：")]),e._v(" "),a("ul",[a("li",[e._v("每天必须休眠 6 个小时")]),e._v(" "),a("li",[e._v("30 分钟内没有外部请求，则休眠。")]),e._v(" "),a("li",[e._v("休眠后如果有新的外部请求实例则马上启动（但激活时此次发送邮件会失败）。")])]),e._v(" "),a("p",[e._v("分析了一下上方的策略，如果不想付费的话，最佳使用方案就设置定时器，每天 7 - 23 点每 20 分钟访问一次，这样可以保持每天的绝大多数时间邮件服务是正常的。")]),e._v(" "),a("p",[e._v("首先需要先配置下 Web 主机的域名【现在叫”云引擎域名“】，使用定时器时要用到。配置方式如下。")]),e._v(" "),a("img",{staticStyle:{zoom:"33%"},attrs:{src:"https://gitee.com/rodrick278/img/raw/master/img/image-20200911185002555.png",alt:"image-20200911185002555"}}),e._v(" "),a("p",[e._v("后台登录需要账号密码，需要在这里设置，只需要填写 "),a("code",[e._v("email")]),e._v("、"),a("code",[e._v("password")]),e._v("、"),a("code",[e._v("username")]),e._v("，这三个字段即可, 使用 "),a("code",[e._v("email")]),e._v(" 作为账号登陆即可。（为了安全考虑，此 "),a("code",[e._v("email")]),e._v(" 必须为配置中的 "),a("code",[e._v("SMTP_USER")]),e._v(" 或 "),a("code",[e._v("TO_EMAIL")]),e._v("， 否则不允许登录） "),a("a",{attrs:{href:"https://camo.githubusercontent.com/6e1b23da8abe54d08a1ce90d35e982c3ce171bb8/68747470733a2f2f63646e2e6a756e362e6e65742f3230313830313131323133335f3436372e706e67",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://camo.githubusercontent.com/6e1b23da8abe54d08a1ce90d35e982c3ce171bb8/68747470733a2f2f63646e2e6a756e362e6e65742f3230313830313131323133335f3436372e706e67",alt:"img"}}),a("OutboundLink")],1)]),e._v(" "),a("h4",{attrs:{id:"leancloud-自带定时器-推荐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#leancloud-自带定时器-推荐"}},[e._v("#")]),e._v(" LeanCloud 自带定时器[推荐]")]),e._v(" "),a("p",[e._v("首先需要添加环境变量，"),a("code",[e._v("ADMIN_URL")]),e._v("："),a("code",[e._v("Web 主机域名【现在叫”云引擎域名“】")]),e._v("，如图所示（添加后重启容器才会生效）：")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://camo.githubusercontent.com/4239e2376c7ead8e71433ad3cf62a6825cf0ee75/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313430395f3136372e706e67",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://camo.githubusercontent.com/4239e2376c7ead8e71433ad3cf62a6825cf0ee75/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313430395f3136372e706e67",alt:"img"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("然后点击云引擎 - 定时任务，新增定时器，按照图片上填写：")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://camo.githubusercontent.com/676c31d97af7ffa113ef0f622891c43f3f3121d4/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313433335f3536382e706e67",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://camo.githubusercontent.com/676c31d97af7ffa113ef0f622891c43f3f3121d4/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313433335f3536382e706e67",alt:"img"}}),a("OutboundLink")],1)]),e._v(" "),a("blockquote",[a("p",[e._v("注意, LeanCloud 最近更新了定时器校验规则, 需要将 Cron 表达式写为: "),a("code",[e._v("0 */20 7-23 * * ?")]),e._v(" !!!")]),e._v(" "),a("p",[e._v("上面这个写法是国内的时间！！！国际版和国内有八小时时差，所以国际版请使用"),a("code",[e._v("0 */20 0-15 * * ?")])])]),e._v(" "),a("p",[e._v("添加后要记得"),a("strong",[e._v("点击启用")]),e._v("：")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://camo.githubusercontent.com/1127fa5a265eac435e643c198e29ca2802eacc20/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313433345f3131382e706e67",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://camo.githubusercontent.com/1127fa5a265eac435e643c198e29ca2802eacc20/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313433345f3131382e706e67",alt:"img"}}),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("启用成功后，每 20 分钟在云引擎的 - 应用日志中可以看到提示：")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://camo.githubusercontent.com/35e08261b6a7d2570c8bab872dc69ffd21116dc0/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313434345f3738332e706e67",target:"_blank",rel:"noopener noreferrer"}},[a("img",{attrs:{src:"https://camo.githubusercontent.com/35e08261b6a7d2570c8bab872dc69ffd21116dc0/68747470733a2f2f63646e2e6a756e362e6e65742f3230313831323031313434345f3738332e706e67",alt:"img"}}),a("OutboundLink")],1)])])]),e._v(" "),a("h3",{attrs:{id:"_5-流控问题解决"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-流控问题解决"}},[e._v("#")]),e._v(" 5. 流控问题解决")]),e._v(" "),a("p",[e._v('​\t用一段时间后，会在日志里发现定时任务报错："因流控原因，通过定时任务唤醒体验版实例失败，建议升级至标准版云引擎实例避免休眠"，官方说法是：')]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/blogimg/picbed@latest/2020/05/14/690052ad1e12bd97d8459f6533fcc64b.png",alt:"img"}})]),e._v(" "),a("p",[e._v("然后我去参照了"),a("a",{attrs:{href:"https://www.antmoe.com/posts/ff6aef7b/",target:"_blank",rel:"noopener noreferrer"}},[e._v("这篇文章"),a("OutboundLink")],1),e._v("，里面介绍的很详细了，就不重复说明了")]),e._v(" "),a("p",[e._v("基本思路就是：")]),e._v(" "),a("p",[e._v("既然你自带的定时任务你可以监控到然后限制，那么我就定时从"),a("strong",[e._v("外部发起请求")]),e._v("，只要外部发起请求没有问题，那就可以保证适当的活跃时间，并且避开白天休眠的情况")]),e._v(" "),a("p",[e._v("使用 "),a("a",{attrs:{href:"https://github.com/features/actions",target:"_blank",rel:"noopener noreferrer"}},[e._v("Github Action"),a("OutboundLink")],1),e._v("，来"),a("strong",[e._v("代替")]),e._v("自带的定时器功能，"),a("strong",[e._v("或者代替")]),e._v("休眠期后的第一次唤醒工作，因为有人发现只要从休眠中的第一次唤醒是外部发起的，后面定时器执行就不会报错")])])}),[],!1,null,null,null);t.default=n.exports}}]);